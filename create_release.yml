create-release:
  needs:
  - placeholder
  runs-on: ubuntu-latest
  permissions:
    contents: write
  steps:
  - name: Download all artifacts
    uses: actions/download-artifact@v4
    with:
      path: artifacts
  - name: List downloaded artifacts
    run: ls -R artifacts/
  - name: Package all artifacts
    run: |-
      STRIP_KEYWORDS=("latest" "15" "arch")
      cd artifacts
      for dir in */; do
        dirname="${dir%/}"
        echo "Processing: $dirname"
        
        clean_name="$dirname"
        for keyword in "${STRIP_KEYWORDS[@]}"; do
          clean_name="${clean_name//$keyword/}"
        done
        
        clean_name=$(echo "$clean_name" | sed 's/--*/-/g; s/^-//; s/-$//')

        case "$dirname" in
          windows-*)
            (cd "$dirname" && zip -r "../../tracy-${clean_name}.zip" ./* )
            echo "Created tracy-${clean_name}.zip"
            ;;
          *)
            tar czf "../tracy-${clean_name}.tar.gz" "$dirname"
            echo "Created tracy-${clean_name}.tar.gz"
            ;;
        esac
      done
      cd ..
  - name: List created packages
    run: ls -lh *.zip *.tar.gz 2>/dev/null || echo "No packages created"
  - name: Create Release
    uses: softprops/action-gh-release@v2
    with:
      name: Tracy ${{ github.ref_name }}
      target_commitish: ${{ github.sha }}
      body: Prebuilt Tracy binaries for ${{ github.ref_name }} from https://github.com/wolfpld/tracy
      files: |-
        *.zip
        *.tar.gz
      fail_on_unmatched_files: true
      overwrite: true
